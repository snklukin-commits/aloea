
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–ø—Ç–µ—á–Ω–∞—è —Å–µ—Ç—å "–ê–ª–æ—ç" | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #6FB644;
            --dark-green: #4CAF50;
            --bg-color: #f4f9f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(76, 175, 80, 0.1);
            --shadow-hover: 0 8px 25px rgba(76, 175, 80, 0.2);

            --purple: #B39DDB;
            --pink: #F8BBD0;
            --cyan: #80DEEA;
            --amber: #FFE0B2;
            --teal: #80CBC4;
            --red: #EF9A9A;
            --indigo: #9FA8DA;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 10px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--primary-green) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-green);
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .logo-container {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .header-text h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 3px 0;
            letter-spacing: -0.5px;
        }

        .header-text p {
            font-size: 12px;
            margin: 0;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            position: relative;
            align-items: center;
        }

        .sync-status {
            font-size: 16px;
            cursor: help;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .sync-status.syncing {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .btn-header {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .settings-menu {
            position: absolute;
            top: 65px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            min-width: 200px;
            animation: slideDown 0.3s ease;
        }

        .settings-menu.active {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e8e3;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--bg-color);
        }

        .settings-item.staff {
            color: #D81B60;
        }

        .settings-item.labels {
            color: #6A1B9A;
        }

        .settings-item.pharmacy {
            color: var(--dark-green);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #f9fdf8 0%, var(--bg-color) 100%);
            border-right: 1px solid #e0e8e3;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid #e0e8e3;
        }

        .sidebar-title {
            font-size: 10px;
            text-transform: uppercase;
            color: #999;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 6px;
        }

        .nav-button {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid #e0e8e3;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .nav-button:hover {
            border-color: #666;
            background: rgba(100, 100, 100, 0.08);
            color: #333;
            transform: translateX(4px);
        }

        .nav-button.active {
            font-weight: 600;
        }

        .nav-button.active.color-purple {
            background: linear-gradient(135deg, rgba(179, 157, 219, 0.2) 0%, rgba(179, 157, 219, 0.1) 100%);
            color: #6A1B9A;
            border-color: #B39DDB;
        }

        .nav-button.active.color-pink {
            background: linear-gradient(135deg, rgba(248, 187, 208, 0.2) 0%, rgba(248, 187, 208, 0.1) 100%);
            color: #C2185B;
            border-color: #F8BBD0;
        }

        .nav-button.active.color-cyan {
            background: linear-gradient(135deg, rgba(128, 222, 234, 0.2) 0%, rgba(128, 222, 234, 0.1) 100%);
            color: #00ACC1;
            border-color: #80DEEA;
        }

        .nav-button.active.color-amber {
            background: linear-gradient(135deg, rgba(255, 224, 178, 0.2) 0%, rgba(255, 224, 178, 0.1) 100%);
            color: #F57F17;
            border-color: #FFE0B2;
        }

        .nav-button.active.color-teal {
            background: linear-gradient(135deg, rgba(128, 203, 196, 0.2) 0%, rgba(128, 203, 196, 0.1) 100%);
            color: #00695C;
            border-color: #80CBC4;
        }

        .nav-button.active.color-red {
            background: linear-gradient(135deg, rgba(239, 154, 154, 0.2) 0%, rgba(239, 154, 154, 0.1) 100%);
            color: #C62828;
            border-color: #EF9A9A;
        }

        .nav-button.active.color-indigo {
            background: linear-gradient(135deg, rgba(159, 168, 218, 0.2) 0%, rgba(159, 168, 218, 0.1) 100%);
            color: #3F51B5;
            border-color: #9FA8DA;
        }

        .nav-delete {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .nav-button:hover .nav-delete {
            opacity: 1;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e0e8e3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .content-header h2 {
            font-size: 18px;
            color: var(--text-color);
            font-weight: 700;
        }

        .filters-toggle {
            background: linear-gradient(135deg, #A5D6D8 0%, #7CBCC4 100%);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            margin: 15px;
            margin-bottom: 0;
            white-space: nowrap;
        }

        .filters-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .filters-box {
            background: linear-gradient(135deg, rgba(165, 214, 216, 0.08) 0%, rgba(124, 188, 196, 0.05) 100%);
            border: 2px solid rgba(165, 214, 216, 0.2);
            border-radius: 10px;
            padding: 0;
            margin: 0 15px 15px 15px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .filters-box.expanded {
            padding: 15px;
            max-height: 500px;
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-select {
            padding: 8px 10px;
            border: 2px solid rgba(165, 214, 216, 0.25);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: white;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:hover {
            border-color: #7CBCC4;
            background: rgba(165, 214, 216, 0.05);
        }

        .filter-select:focus {
            outline: none;
            border-color: #7CBCC4;
            box-shadow: 0 0 0 3px rgba(165, 214, 216, 0.1);
        }

        .filters-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .filter-clear {
            padding: 8px 12px;
            background: #FFCDD2;
            border: 2px solid #EF9A9A;
            border-radius: 6px;
            color: #C62828;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .filter-clear:hover {
            background: #F1A9A0;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 15px 15px 15px;
            background: var(--bg-color);
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 100%;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            border: 1px solid #e0e8e3;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 3px solid transparent;
            justify-content: space-between;
        }

        .panel.tasks .panel-header {
            border-bottom-color: var(--primary-green);
        }

        .panel.notes .panel-header {
            border-bottom-color: #FFE0B2;
        }

        .panel.all-tasks .panel-header {
            border-bottom-color: #B39DDB;
        }

        .panel.all-notes .panel-header {
            border-bottom-color: #80CBC4;
        }

        .panel-icon {
            font-size: 20px;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-color);
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add-item {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #9FA8DA 0%, #B39DDB 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-add-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(179, 157, 219, 0.2);
        }

        .btn-toggle-completed {
            padding: 4px 8px;
            background: rgba(179, 157, 219, 0.1);
            border: 1px solid #B39DDB;
            color: #6A1B9A;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-toggle-completed:hover {
            background: rgba(179, 157, 219, 0.2);
        }

        .items-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-card {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-green);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .item-card.note {
            border-left-color: #FFE0B2;
        }

        .item-card:hover {
            background: rgba(165, 214, 216, 0.05);
            box-shadow: 0 2px 8px rgba(165, 214, 216, 0.1);
            transform: translateX(2px);
        }

        .item-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .item-meta {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(165, 214, 216, 0.1);
            color: #7CBCC4;
            border-radius: 3px;
            font-weight: 600;
            font-size: 9px;
            border: 1px solid rgba(165, 214, 216, 0.2);
        }

        .tag.pharmacy {
            background: rgba(128, 222, 234, 0.15);
            color: #00ACC1;
            border-color: #80DEEA;
        }

        .tag.staff {
            background: rgba(248, 187, 208, 0.15);
            color: #C2185B;
            border-color: #F8BBD0;
        }

        .tag.deadline {
            background: rgba(255, 224, 178, 0.15);
            color: #F57F17;
            border-color: #FFE0B2;
        }

        .tag.overdue {
            background: rgba(239, 154, 154, 0.15);
            color: #C62828;
            border-color: #EF9A9A;
        }

        .item-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            z-index: 10;
        }

        .item-card:hover .item-delete {
            opacity: 1;
            color: #EF9A9A;
        }

        .task-card {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--dark-green);
            flex-shrink: 0;
            z-index: 10;
        }

        .task-card.completed .item-title {
            text-decoration: line-through;
            color: #ccc;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
            font-size: 12px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(165, 214, 216, 0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e0e8e3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(165, 214, 216, 0.05) 0%, rgba(124, 188, 196, 0.05) 100%);
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 12px 15px;
            border-top: 1px solid #e0e8e3;
            display: flex;
            gap: 8px;
            background: var(--bg-color);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-color);
            font-size: 12px;
        }

        .form-required::after {
            content: " *";
            color: #EF9A9A;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e8e3;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--bg-color);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #7CBCC4;
            box-shadow: 0 0 0 3px rgba(165, 214, 216, 0.1);
            background: var(--card-bg);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9FA8DA 0%, #B39DDB 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(179, 157, 219, 0.2);
        }

        .btn-secondary {
            background: #e0e8e3;
            color: var(--text-color);
            border: 1px solid #d0d8d3;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #d0d8d3;
        }

        .btn-danger {
            background: #FFCDD2;
            color: #C62828;
            border: 2px solid #EF9A9A;
            padding: 4px 8px;
            font-size: 10px;
        }

        .btn-danger:hover {
            background: #F1A9A0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .table th {
            background: linear-gradient(135deg, rgba(165, 214, 216, 0.1) 0%, rgba(124, 188, 196, 0.08) 100%);
            padding: 8px;
            text-align: left;
            font-weight: 700;
            color: #7CBCC4;
            border-bottom: 2px solid #e0e8e3;
        }

        .table td {
            padding: 8px;
            border-bottom: 1px solid #e0e8e3;
        }

        .table tr:hover {
            background: rgba(165, 214, 216, 0.05);
        }

        .labels-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .label-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(165, 214, 216, 0.1);
            color: #7CBCC4;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(165, 214, 216, 0.15);
        }

        .label-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 12px;
            transition: color 0.2s;
        }

        .label-remove:hover {
            color: #C62828;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(165, 214, 216, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(165, 214, 216, 0.5);
        }

        @media (max-width: 1024px) {
            .filters-container {
                grid-template-columns: 1fr;
            }
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                height: calc(100vh - 20px);
            }
            .header {
                padding: 12px;
            }
            .logo-section {
                width: 100%;
            }
            .header-right {
                width: 100%;
                justify-content: flex-start;
            }
            .main-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 2px solid #e0e8e3;
                padding: 12px;
                padding-bottom: 0;
            }
            .sidebar-section {
                border-bottom: none;
                padding: 8px 0;
            }
            .sidebar-section:nth-child(2) {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 0;
            }
            .sidebar-section:nth-child(2) .sidebar-title {
                grid-column: 1 / -1;
            }
            .sidebar-section:nth-child(2) .nav-list {
                display: contents;
            }
            .sidebar-section:nth-child(2) .nav-item {
                margin-bottom: 0;
            }
            .content-header {
                padding: 12px;
            }
            .content-header h2 {
                font-size: 16px;
            }
            .filters-toggle {
                margin: 12px 12px 8px 12px;
            }
            .filters-box {
                margin: 0 12px 12px 12px;
            }
            .filters-container {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .grid-layout {
                gap: 12px;
            }
            .panel {
                padding: 12px;
            }
            .modal {
                border-radius: 8px;
            }
            .settings-menu {
                top: 50px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <div class="logo-section">
            <div class="logo-container">
                <img src="https://aloeapteka.ru/local/templates/aloe/favicon-600.png" alt="–õ–æ–≥–æ—Ç–∏–ø –ê–ª–æ—ç">
            </div>
            <div class="header-text">
                <h1>–ê–ø—Ç–µ—á–Ω–∞—è —Å–µ—Ç—å ¬´–ê–ª–æ—ç¬ª</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</p>
            </div>
        </div>
        <div class="header-right">
            <div class="sync-status" id="syncStatus" title="–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">üîÑ</div>
            <button class="btn-header" id="settingsBtn" onclick="toggleSettings(event)">
                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <div class="settings-menu" id="settingsMenu">
                <div class="settings-item staff" onclick="openStaffModal()">
                    üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                </div>
                <div class="settings-item labels" onclick="openLabelsModal()">
                    üè∑Ô∏è –Ø—Ä–ª—ã–∫–∏
                </div>
                <div class="settings-item pharmacy" onclick="openPharmacyManagementModal()">
                    üè• –ê–ø—Ç–µ–∫–∏
                </div>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <button class="nav-button" onclick="showDashboard()">
                            üìä –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-button" onclick="selectPharmacy('common')">
                            üìå –û–±—â–∏–µ –∑–∞–¥–∞—á–∏
                        </button>
                    </li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">–ê–ø—Ç–µ–∫–∏</h3>
                <ul class="nav-list" id="pharmaciesList"></ul>
            </div>
        </div>

        <div class="content">
            <div class="content-header">
                <h2 id="contentTitle">üìä –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</h2>
            </div>

            <button class="filters-toggle collapsed" onclick="toggleFilters()">
                ‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã
            </button>

            <div class="filters-box" id="filtersBox">
                <div class="filters-container">
                    <div class="filter-group">
                        <label class="filter-label">üè• –ê–ø—Ç–µ–∫–∞</label>
                        <select class="filter-select" id="filterPharmacy" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üë§ –°–æ—Ç—Ä—É–¥.</label>
                        <select class="filter-select" id="filterStaff" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üè∑Ô∏è –Ø—Ä–ª—ã–∫</label>
                        <select class="filter-select" id="filterLabel" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÖ –°—Ä–æ–∫</label>
                        <select class="filter-select" id="filterDeadline" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week">–ù–µ–¥–µ–ª—è</option>
                            <option value="month">–ú–µ—Å—è—Ü</option>
                            <option value="overdue">–ü—Ä–æ—Å—Ä.</option>
                        </select>
                    </div>
                </div>
                <div class="filters-footer">
                    <button class="filter-clear" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>

            <div class="content-area">
                <div id="dashboardView">
                    <div class="grid-layout">
                        <div class="panel all-tasks">
                            <div class="panel-header">
                                <div class="panel-header-left">
                                    <span class="panel-icon">‚úì</span>
                                    <h3 class="panel-title">–ó–∞–¥–∞—á–∏</h3>
                                </div>
                                <button class="btn-toggle-completed" onclick="toggleShowCompleted('dashboard')">
                                    –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
                                </button>
                            </div>
                            <div class="items-container" id="allTasksList"></div>
                        </div>
                        <div class="panel all-notes">
                            <div class="panel-header">
                                <div class="panel-header-left">
                                    <span class="panel-icon">üìù</span>
                                    <h3 class="panel-title">–ó–∞–º–µ—Ç–∫–∏</h3>
                                </div>
                            </div>
                            <div class="items-container" id="allNotesList"></div>
                        </div>
                    </div>
                </div>

                <div id="pharmacyView" class="grid-layout" style="display: none;">
                    <div class="panel tasks">
                        <div class="panel-header">
                            <div class="panel-header-left">
                                <span class="panel-icon">‚úì</span>
                                <h3 class="panel-title">–ó–∞–¥–∞—á–∏</h3>
                            </div>
                            <button class="btn-toggle-completed" onclick="toggleShowCompleted('pharmacy')">
                                –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
                            </button>
                        </div>
                        <button class="btn-add-item" onclick="openAddTask()">+ –ó–∞–¥–∞—á–∞</button>
                        <div class="items-container" id="pharmacyTasksList"></div>
                    </div>
                    <div class="panel notes">
                        <div class="panel-header">
                            <div class="panel-header-left">
                                <span class="panel-icon">üìù</span>
                                <h3 class="panel-title">–ó–∞–º–µ—Ç–∫–∏</h3>
                            </div>
                        </div>
                        <button class="btn-add-item" onclick="openAddNote()">+ –ó–∞–º–µ—Ç–∫–∞</button>
                        <div class="items-container" id="pharmacyNotesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="pharmacyManagementModal" onclick="closeModalOnBackdrop(event, 'pharmacyManagementModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</h2>
            <button class="modal-close" onclick="closeModal('pharmacyManagementModal')">√ó</button>
        </div>
        <div class="modal-body">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="openCreatePharmacy()">
                + –ù–æ–≤–∞—è –∞–ø—Ç–µ–∫–∞
            </button>
            <div id="pharmacyManagementList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('pharmacyManagementModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="createPharmacyModal" onclick="closeModalOnBackdrop(event, 'createPharmacyModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–°–æ–∑–¥–∞—Ç—å –∞–ø—Ç–µ–∫—É</h2>
            <button class="modal-close" onclick="closeModal('createPharmacyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏</label>
                <input type="text" id="pharmacyNumberInput" class="form-input" placeholder="1">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="pharmacyAddressInput" class="form-input" placeholder="—É–ª. –ë–æ–ª—å—à–∞—è –ü–æ–∫—Ä–æ–≤—Å–∫–∞—è, –¥. 1">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="createPharmacy()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('createPharmacyModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editPharmacyModal" onclick="closeModalOnBackdrop(event, 'editPharmacyModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ø—Ç–µ–∫—É</h2>
            <button class="modal-close" onclick="closeModal('editPharmacyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏</label>
                <input type="text" id="editPharmacyNumberInput" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="editPharmacyAddressInput" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveEditedPharmacy()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('editPharmacyModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addNoteModal" onclick="closeModalOnBackdrop(event, 'addNoteModal')">
    <div class="modal">
        <div class="modal-header">
            <h2 id="noteModalTitle">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
            <button class="modal-close" onclick="closeModal('addNoteModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–¢–µ–∫—Å—Ç</label>
                <textarea id="noteTextInput" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('addNoteModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" id="deleteNoteBtn" style="display: none; margin-left: auto;" onclick="deleteNoteModal()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addTaskModal" onclick="closeModalOnBackdrop(event, 'addTaskModal')">
    <div class="modal">
        <div class="modal-header">
            <h2 id="taskModalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
            <button class="modal-close" onclick="closeModal('addTaskModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ó–∞–¥–∞—á–∞</label>
                <input type="text" id="taskTitleInput" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
            </div>
            <div class="form-group">
                <label class="form-label">–Ø—Ä–ª—ã–∫</label>
                <select id="taskLabelInput" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤.</label>
                <select id="taskStaffInput" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–°—Ä–æ–∫</label>
                <input type="date" id="taskDeadlineInput" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveTask()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('addTaskModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" id="deleteTaskBtn" style="display: none; margin-left: auto;" onclick="deleteTaskModal()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="staffModal" onclick="closeModalOnBackdrop(event, 'staffModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
            <button class="modal-close" onclick="closeModal('staffModal')">√ó</button>
        </div>
        <div class="modal-body">
            <h3 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color); font-weight: 700;">–î–æ–±–∞–≤–∏—Ç—å</h3>
            <div class="form-group">
                <label class="form-label form-required">–§–ò–û</label>
                <input type="text" id="staffNameInput" class="form-input" placeholder="–§–ò–û">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                <input type="text" id="staffPositionInput" class="form-input" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="staffPhoneInput" class="form-input" placeholder="+7 (900) 123-45-67">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="staffEmailInput" class="form-input" placeholder="email@example.com">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="addStaff()">–î–æ–±–∞–≤–∏—Ç—å</button>

            <h3 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color); font-weight: 700;">–°–ø–∏—Å–æ–∫</h3>
            <div id="staffTableContainer"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('staffModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editStaffModal" onclick="closeModalOnBackdrop(event, 'editStaffModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            <button class="modal-close" onclick="closeModal('editStaffModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–§–ò–û</label>
                <input type="text" id="editStaffNameInput" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                <input type="text" id="editStaffPositionInput" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="editStaffPhoneInput" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="editStaffEmailInput" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveEditedStaff()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('editStaffModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="labelsModal" onclick="closeModalOnBackdrop(event, 'labelsModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–Ø—Ä–ª—ã–∫–∏</h2>
            <button class="modal-close" onclick="closeModal('labelsModal')">√ó</button>
        </div>
        <div class="modal-body">
            <h3 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color); font-weight: 700;">–î–æ–±–∞–≤–∏—Ç—å</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="text" id="newLabelInput" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." style="flex: 1;">
                <button class="btn btn-primary" style="flex: 0 0 80px; font-size: 11px;" onclick="addLabel()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <h3 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color); font-weight: 700;">–¢–µ–∫—É—â–∏–µ</h3>
            <div class="labels-container" id="labelsListContainer"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('labelsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCXU_qtA65zudpgUsdNdbndOSpuGRbEJ2c",
        authDomain: "pharmacy-manager-d7802.firebaseapp.com",
        projectId: "pharmacy-manager-d7802",
        storageBucket: "pharmacy-manager-d7802.firebasestorage.app",
        messagingSenderId: "60028648458",
        appId: "1:60028648458:web:45e2a124ea3b7d7c46f3f3",
    };

    try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
    } catch(e) { 
        console.error("Firebase Init Fail", e); 
    }

    const DOC_REF = db.collection("pharmacy_app").doc("pharmacy_tasks");

    let appData = {
        pharmacies: [],
        currentPharmacy: null,
        staff: [
            { id: 'staff_1', name: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', position: '–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞', phone: '+7 (904) 252-31-00', email: 'a.bocharova@aloea.ru' },
            { id: 'staff_2', name: '–ö–æ—à–µ–ª–µ–≤–∞ –ï.–ê.', position: '–î–∏—Ä–µ–∫—Ç–æ—Ä –†–µ–≥–∏–æ–Ω–∞', phone: '+7 (904) 653-29-38', email: 'e.kosheleva@aloea.ru' },
            { id: 'staff_3', name: '–ö–ª—é–∫–∏–Ω –°.–ù.', position: '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', phone: '+7 (904) 041-00-17', email: 's.klyukin@aloea.ru' },
            { id: 'staff_4', name: '–í–æ—Å—Ç–æ–∫–æ–≤–∞ –Æ.–í.', position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É', phone: '+7 (919) 025-15-98', email: 'y.vostokova@aloea.ru' },
            { id: 'staff_5', name: '–ü–∞–≤–ª–æ–≤ –ê.–§.', position: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', phone: '+7 (920) 916-97-09', email: 'a.pavlov@aloea.ru' },
            { id: 'staff_6', name: '–ì–∞—Ä–≤–∏–Ω –†.', position: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ê–•–û', phone: '+7 (904) 857-73-73', email: 'r.gavrin@aloea.ru' },
            { id: 'staff_7', name: '–ì–æ—Ä–æ—à–∏–ª–æ–≤–∞ –ù.–ù.', position: '–°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä', phone: '+7 (953) 343-59-36', email: 'n.goroshilova@aloea.ru' },
            { id: 'staff_8', name: '–ú–∞—à–µ—Ä–∏—á–µ–≤–∞ –ú.–ê.', position: '–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥', phone: '+7 (999) 799-36-06', email: 'm.evstrat@aloea.ru' }
        ],
        labels: ['–°—Ä–æ—á–Ω–æ', '–í–∞–∂–Ω–æ', '–†–µ–≥—É–ª—è—Ä–Ω–æ', '–†–µ–∫–ª–∞–º–∞', '–ê–•–û', '–û—Ç–¥–µ–ª –∫–∞–¥—Ä–æ–≤'],
        common: { notes: [], tasks: [] }
    };

    let currentFilters = { pharmacy: '', staff: '', label: '', deadline: '' };
    let showCompletedTasks = { dashboard: false, pharmacy: false };
    const pharmacyColors = ['color-purple', 'color-pink', 'color-cyan', 'color-amber', 'color-teal', 'color-red', 'color-indigo'];
    let editingPharmacyId = null, editingStaffId = null;
    let editingTask = null, editingNote = null;

    function setSyncStatus(msg, type) {
        const el = document.getElementById('syncStatus');
        if (!el) return;
        
        let icon = 'üîÑ';
        if (type === 'syncing') {
            icon = '‚è≥';
            el.classList.add('syncing');
        } else if (type === 'success') {
            icon = '‚úÖ';
            el.classList.remove('syncing');
        } else if (type === 'error') {
            icon = '‚ùå';
            el.classList.remove('syncing');
        } else if (type === 'loading') {
            icon = 'üîÑ';
            el.classList.add('syncing');
        }
        
        el.innerHTML = icon;
        el.title = msg;
    }

    function toggleSettings(e) {
        e.stopPropagation();
        document.getElementById('settingsMenu').classList.toggle('active');
    }

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('settingsMenu');
        const btn = document.getElementById('settingsBtn');
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.classList.remove('active');
        }
    });

    function toggleFilters() {
        const filtersBox = document.getElementById('filtersBox');
        const button = document.querySelector('.filters-toggle');
        filtersBox.classList.toggle('expanded');
        button.classList.toggle('collapsed');
    }

    function initFirebaseSync() {
        setSyncStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'loading');
        
        DOC_REF.onSnapshot((doc) => {
            if (doc.exists) {
                const loaded = doc.data();
                appData.pharmacies = loaded.pharmacies || [];
                appData.currentPharmacy = loaded.currentPharmacy || null;
                appData.labels = loaded.labels || [];
                appData.staff = loaded.staff || [];
                appData.common = loaded.common || { notes: [], tasks: [] };
                
                setSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success');
            } else {
                setSyncStatus('–ì–æ—Ç–æ–≤–æ', 'success');
            }
            
            renderPharmacies();
            updateTaskSelects();
            updateFilterOptions();
            
            if (document.getElementById('dashboardView').style.display !== 'none') {
                renderDashboard();
            } else if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else if (appData.currentPharmacy) {
                renderPharmacy();
            }
        }, (error) => {
            setSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
            console.error('Firestore listener error:', error);
        });
    }

    function saveData() {
        setSyncStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'syncing');
        
        const dataToSave = {
            pharmacies: appData.pharmacies,
            currentPharmacy: appData.currentPharmacy,
            labels: appData.labels,
            staff: appData.staff,
            common: appData.common
        };

        DOC_REF.set(dataToSave, { merge: true })
            .then(() => setSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success'))
            .catch(err => {
                setSyncStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                console.error('Firestore save error:', err);
            });
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function closeModalOnBackdrop(event, modalId) {
        if (event.target.id === modalId) {
            closeModal(modalId);
        }
    }

    function toggleShowCompleted(view) {
        showCompletedTasks[view] = !showCompletedTasks[view];
        if (view === 'dashboard') {
            renderDashboard();
        } else {
            if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
        }
    }

    // PHARMACIES
    function openPharmacyManagementModal() {
        renderPharmacyManagementList();
        openModal('pharmacyManagementModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function renderPharmacyManagementList() {
        const container = document.getElementById('pharmacyManagementList');
        if (!appData.pharmacies.length) {
            container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∞–ø—Ç–µ–∫</div>';
            return;
        }

        let html = '<table class="table"><thead><tr><th>‚Ññ</th><th>–ê–¥—Ä–µ—Å</th><th></th></tr></thead><tbody>';
        appData.pharmacies.forEach(p => {
            html += `<tr>
                <td>${p.number}</td>
                <td>${p.address}</td>
                <td style="text-align: right;">
                    <button class="btn btn-danger" onclick="openEditPharmacy(${p.id})" style="margin-right: 4px;">‚úé</button>
                    <button class="btn btn-danger" onclick="deletePharmacy(${p.id})">‚úï</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function openCreatePharmacy() {
        document.getElementById('pharmacyNumberInput').value = '';
        document.getElementById('pharmacyAddressInput').value = '';
        openModal('createPharmacyModal');
        document.getElementById('pharmacyNumberInput').focus();
    }

    function createPharmacy() {
        const number = document.getElementById('pharmacyNumberInput').value.trim();
        const address = document.getElementById('pharmacyAddressInput').value.trim();

        if (!number || !address) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –∞–¥—Ä–µ—Å –∞–ø—Ç–µ–∫–∏');
            return;
        }

        appData.pharmacies.push({
            id: Date.now(),
            name: `–ê–ø—Ç–µ–∫–∞ ‚Ññ${number}`,
            number,
            address,
            notes: [],
            tasks: []
        });

        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        saveData();
        closeModal('createPharmacyModal');
    }

    function openEditPharmacy(id) {
        const pharmacy = appData.pharmacies.find(p => p.id === id);
        if (!pharmacy) return;

        editingPharmacyId = id;
        document.getElementById('editPharmacyNumberInput').value = pharmacy.number || '';
        document.getElementById('editPharmacyAddressInput').value = pharmacy.address || '';
        openModal('editPharmacyModal');
    }

    function saveEditedPharmacy() {
        const pharmacy = appData.pharmacies.find(p => p.id === editingPharmacyId);
        if (!pharmacy) {
            alert('–ê–ø—Ç–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }

        const number = document.getElementById('editPharmacyNumberInput').value.trim();
        const address = document.getElementById('editPharmacyAddressInput').value.trim();

        if (!number || !address) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –∞–¥—Ä–µ—Å –∞–ø—Ç–µ–∫–∏');
            return;
        }

        pharmacy.number = number;
        pharmacy.address = address;
        pharmacy.name = `–ê–ø—Ç–µ–∫–∞ ‚Ññ${number}`;

        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        if (appData.currentPharmacy === pharmacy.id) {
            showPharmacy();
        }
        saveData();
        closeModal('editPharmacyModal');
        editingPharmacyId = null;
    }

    function deletePharmacy(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–ø—Ç–µ–∫—É?')) return;
        appData.pharmacies = appData.pharmacies.filter(p => p.id !== id);
        if (appData.currentPharmacy === id) appData.currentPharmacy = null;
        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        showDashboard();
        saveData();
    }

    function selectPharmacy(id) {
        appData.currentPharmacy = id;
        saveData();
        if (id === 'common') {
            showCommon();
        } else {
            showPharmacy();
        }
    }

    function renderPharmacies() {
        const list = document.getElementById('pharmaciesList');
        list.innerHTML = '';
        appData.pharmacies.forEach((p, idx) => {
            const colorClass = pharmacyColors[idx % pharmacyColors.length];
            const isActive = appData.currentPharmacy === p.id;
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.innerHTML = `
                <button class="nav-button ${isActive ? 'active ' + colorClass : ''}" onclick="selectPharmacy(${p.id})">
                    <span>‚Ññ${p.number}</span>
                    <button class="nav-delete" onclick="deletePharmacy(${p.id}); event.stopPropagation();">‚úï</button>
                </button>
            `;
            list.appendChild(li);
        });
    }

    // NOTES
    function openAddNote() {
        if (!appData.currentPharmacy) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É –∏–ª–∏ –û–±—â–∏–µ –∑–∞–¥–∞—á–∏');
            return;
        }
        editingNote = null;
        document.getElementById('noteModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞';
        document.getElementById('deleteNoteBtn').style.display = 'none';
        document.getElementById('noteTextInput').value = '';
        openModal('addNoteModal');
        document.getElementById('noteTextInput').focus();
    }

    function openEditNote(noteIdx) {
        let target;
        if (appData.currentPharmacy === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (!target || !target.notes || !target.notes[noteIdx]) {
            alert('–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }

        editingNote = { index: noteIdx, pharmacyId: appData.currentPharmacy };
        document.getElementById('noteModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É';
        document.getElementById('deleteNoteBtn').style.display = 'block';
        document.getElementById('noteTextInput').value = target.notes[noteIdx].text;
        openModal('addNoteModal');
        document.getElementById('noteTextInput').focus();
    }

    function saveNote() {
        const text = document.getElementById('noteTextInput').value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
            return;
        }

        let target;
        if (appData.currentPharmacy === 'common') {
            if (!appData.common) appData.common = { notes: [], tasks: [] };
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (!target) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∞–ø—Ç–µ–∫–∞');
            return;
        }

        target.notes = target.notes || [];
        
        if (editingNote) {
            target.notes[editingNote.index].text = text;
        } else {
            target.notes.unshift({
                text,
                date: new Date().toISOString()
            });
        }

        if (appData.currentPharmacy === 'common') {
            renderCommon();
        } else {
            renderPharmacy();
        }
        renderDashboard();
        saveData();
        closeModal('addNoteModal');
        editingNote = null;
    }

    function deleteNoteModal() {
        if (!editingNote) return;
        let target;
        if (editingNote.pharmacyId === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === editingNote.pharmacyId);
        }

        if (target && target.notes) {
            target.notes.splice(editingNote.index, 1);
            if (editingNote.pharmacyId === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
            renderDashboard();
            saveData();
            closeModal('addNoteModal');
            editingNote = null;
        }
    }

    function deleteNote(noteIdx) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;

        let target;
        if (appData.currentPharmacy === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (target && target.notes) {
            target.notes.splice(noteIdx, 1);
            if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
            renderDashboard();
            saveData();
        }
    }

    // TASKS
    function openAddTask() {
        if (!appData.currentPharmacy) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É –∏–ª–∏ –û–±—â–∏–µ –∑–∞–¥–∞—á–∏');
            return;
        }
        editingTask = null;
        document.getElementById('taskModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
        document.getElementById('deleteTaskBtn').style.display = 'none';
        document.getElementById('taskTitleInput').value = '';
        document.getElementById('taskLabelInput').value = '';
        document.getElementById('taskStaffInput').value = '';
        document.getElementById('taskDeadlineInput').value = '';
        updateTaskSelects();
        openModal('addTaskModal');
        document.getElementById('taskTitleInput').focus();
    }

    function openEditTask(taskIdx) {
        let target;
        if (appData.currentPharmacy === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (!target || !target.tasks || !target.tasks[taskIdx]) {
            alert('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }

        const task = target.tasks[taskIdx];
        editingTask = { index: taskIdx, pharmacyId: appData.currentPharmacy };
        document.getElementById('taskModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
        document.getElementById('deleteTaskBtn').style.display = 'block';
        document.getElementById('taskTitleInput').value = task.title;
        document.getElementById('taskLabelInput').value = task.label || '';
        document.getElementById('taskStaffInput').value = task.staffId || '';
        document.getElementById('taskDeadlineInput').value = task.deadline || '';
        updateTaskSelects();
        openModal('addTaskModal');
        document.getElementById('taskTitleInput').focus();
    }

    function saveTask() {
        const title = document.getElementById('taskTitleInput').value.trim();
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            return;
        }

        let target;
        if (appData.currentPharmacy === 'common') {
            if (!appData.common) appData.common = { notes: [], tasks: [] };
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (!target) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∞–ø—Ç–µ–∫–∞');
            return;
        }

        target.tasks = target.tasks || [];
        
        const taskData = {
            title,
            label: document.getElementById('taskLabelInput').value,
            staffId: document.getElementById('taskStaffInput').value,
            deadline: document.getElementById('taskDeadlineInput').value,
            completed: editingTask ? target.tasks[editingTask.index].completed : false
        };

        if (editingTask) {
            target.tasks[editingTask.index] = taskData;
        } else {
            taskData.completed = false;
            target.tasks.unshift(taskData);
        }

        if (appData.currentPharmacy === 'common') {
            renderCommon();
        } else {
            renderPharmacy();
        }
        renderDashboard();
        saveData();
        closeModal('addTaskModal');
        editingTask = null;
    }

    function deleteTaskModal() {
        if (!editingTask) return;
        let target;
        if (editingTask.pharmacyId === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === editingTask.pharmacyId);
        }

        if (target && target.tasks) {
            target.tasks.splice(editingTask.index, 1);
            if (editingTask.pharmacyId === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
            renderDashboard();
            saveData();
            closeModal('addTaskModal');
            editingTask = null;
        }
    }

    function toggleTask(taskIdx) {
        let target;
        if (appData.currentPharmacy === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (target && target.tasks && target.tasks[taskIdx]) {
            target.tasks[taskIdx].completed = !target.tasks[taskIdx].completed;
            if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
            renderDashboard();
            saveData();
        }
    }

    function deleteTask(taskIdx) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;

        let target;
        if (appData.currentPharmacy === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        }

        if (target && target.tasks) {
            target.tasks.splice(taskIdx, 1);
            if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
            renderDashboard();
            saveData();
        }
    }

    // STAFF
    function openStaffModal() {
        renderStaffTable();
        openModal('staffModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function addStaff() {
        const name = document.getElementById('staffNameInput').value.trim();
        const position = document.getElementById('staffPositionInput').value.trim();
        if (!name || !position) {
            alert('–§–ò–û –∏ –î–æ–ª–∂–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
            return;
        }
        appData.staff.push({
            id: 'staff_' + Date.now(),
            name,
            position,
            phone: document.getElementById('staffPhoneInput').value.trim(),
            email: document.getElementById('staffEmailInput').value.trim()
        });
        renderStaffTable();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
        document.getElementById('staffNameInput').value = '';
        document.getElementById('staffPositionInput').value = '';
        document.getElementById('staffPhoneInput').value = '';
        document.getElementById('staffEmailInput').value = '';
    }

    function openEditStaff(id) {
        const staff = appData.staff.find(s => s.id === id);
        if (!staff) return;

        editingStaffId = id;
        document.getElementById('editStaffNameInput').value = staff.name || '';
        document.getElementById('editStaffPositionInput').value = staff.position || '';
        document.getElementById('editStaffPhoneInput').value = staff.phone || '';
        document.getElementById('editStaffEmailInput').value = staff.email || '';
        openModal('editStaffModal');
    }

    function saveEditedStaff() {
        const staff = appData.staff.find(s => s.id === editingStaffId);
        if (!staff) {
            alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        const name = document.getElementById('editStaffNameInput').value.trim();
        const position = document.getElementById('editStaffPositionInput').value.trim();

        if (!name || !position) {
            alert('–§–ò–û –∏ –î–æ–ª–∂–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
            return;
        }

        staff.name = name;
        staff.position = position;
        staff.phone = document.getElementById('editStaffPhoneInput').value.trim();
        staff.email = document.getElementById('editStaffEmailInput').value.trim();

        renderStaffTable();
        updateTaskSelects();
        updateFilterOptions();
        renderPharmacy();
        renderDashboard();
        saveData();
        closeModal('editStaffModal');
        editingStaffId = null;
    }

    function deleteStaff(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        appData.staff = appData.staff.filter(s => s.id !== id);
        renderStaffTable();
        updateTaskSelects();
        updateFilterOptions();
        renderPharmacy();
        renderDashboard();
        saveData();
    }

    function renderStaffTable() {
        const container = document.getElementById('staffTableContainer');
        if (!appData.staff.length) {
            container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
            return;
        }
        let html = '<table class="table"><thead><tr><th>–§–ò–û</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–¢–µ–ª.</th><th></th></tr></thead><tbody>';
        appData.staff.forEach(s => {
            html += `<tr>
                <td>${s.name}</td>
                <td>${s.position}</td>
                <td><a href="tel:${s.phone}" style="color: #7CBCC4; text-decoration: none; font-size: 10px;">${s.phone}</a></td>
                <td style="text-align: right;">
                    <button class="btn btn-danger" onclick="openEditStaff('${s.id}')" style="margin-right: 4px;">‚úé</button>
                    <button class="btn btn-danger" onclick="deleteStaff('${s.id}')">X</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // LABELS
    function openLabelsModal() {
        renderLabelsList();
        openModal('labelsModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function addLabel() {
        const name = document.getElementById('newLabelInput').value.trim();
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            return;
        }
        if (appData.labels.includes(name)) {
            alert('–¢–∞–∫–æ–π —è—Ä–ª—ã–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }
        appData.labels.push(name);
        renderLabelsList();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
        document.getElementById('newLabelInput').value = '';
    }

    function deleteLabel(name) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        appData.labels = appData.labels.filter(l => l !== name);
        renderLabelsList();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
    }

    function renderLabelsList() {
        const container = document.getElementById('labelsListContainer');
        if (!appData.labels.length) {
            container.innerHTML = '<div class="empty-state">–ù–µ—Ç —è—Ä–ª—ã–∫–æ–≤</div>';
            return;
        }
        let html = '';
        appData.labels.forEach(l => {
            html += `<div class="label-badge">${l}<button class="label-remove" onclick="deleteLabel('${l}')">‚úï</button></div>`;
        });
        container.innerHTML = html;
    }

    function updateTaskSelects() {
        let labelHtml = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
        appData.labels.forEach(l => { labelHtml += `<option value="${l}">${l}</option>`; });
        document.getElementById('taskLabelInput').innerHTML = labelHtml;

        let staffHtml = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
        appData.staff.forEach(s => { staffHtml += `<option value="${s.id}">${s.name}</option>`; });
        document.getElementById('taskStaffInput').innerHTML = staffHtml;
    }

    // FILTERS
    function updateFilterOptions() {
        let pharmacyHtml = '<option value="">–í—Å–µ</option>';
        pharmacyHtml += `<option value="common">–û–±—â–∏–µ –∑–∞–¥–∞—á–∏</option>`;
        appData.pharmacies.forEach(p => {
            pharmacyHtml += `<option value="${p.id}">‚Ññ${p.number} ‚Äî ${p.address}</option>`;
        });
        document.getElementById('filterPharmacy').innerHTML = pharmacyHtml;

        let staffHtml = '<option value="">–í—Å–µ</option>';
        appData.staff.forEach(s => {
            staffHtml += `<option value="${s.id}">${s.name}</option>`;
        });
        document.getElementById('filterStaff').innerHTML = staffHtml;

        let labelHtml = '<option value="">–í—Å–µ</option>';
        appData.labels.forEach(l => {
            labelHtml += `<option value="${l}">${l}</option>`;
        });
        document.getElementById('filterLabel').innerHTML = labelHtml;
    }

    function applyFilters() {
        currentFilters.pharmacy = document.getElementById('filterPharmacy').value;
        currentFilters.staff = document.getElementById('filterStaff').value;
        currentFilters.label = document.getElementById('filterLabel').value;
        currentFilters.deadline = document.getElementById('filterDeadline').value;
        renderDashboard();
    }

    function clearFilters() {
        currentFilters = { pharmacy: '', staff: '', label: '', deadline: '' };
        document.getElementById('filterPharmacy').value = '';
        document.getElementById('filterStaff').value = '';
        document.getElementById('filterLabel').value = '';
        document.getElementById('filterDeadline').value = '';
        renderDashboard();
    }

    function matchesFilters(task) {
        if (currentFilters.pharmacy && String(task.pharmacyId) !== String(currentFilters.pharmacy)) return false;
        if (currentFilters.staff && task.staffId !== currentFilters.staff) return false;
        if (currentFilters.label && task.label !== currentFilters.label) return false;
        if (currentFilters.deadline) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadline = task.deadline ? new Date(task.deadline) : null;

            if (!deadline) return false;

            switch (currentFilters.deadline) {
                case 'today':
                    return deadline.getTime() === today.getTime();
                case 'week':
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    return deadline >= today && deadline <= weekEnd;
                case 'month':
                    return deadline.getMonth() === today.getMonth() &&
                           deadline.getFullYear() === today.getFullYear();
                case 'overdue':
                    return deadline < today && !task.completed;
            }
        }
        return true;
    }

    // RENDERING
    function renderPharmacy() {
        const pharmacy = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        if (!pharmacy) return;

        document.getElementById('contentTitle').textContent = `üì¶ –ê–ø—Ç–µ–∫–∞ ‚Ññ${pharmacy.number} ‚Äî ${pharmacy.address}`;

        let notesHtml = '';
        if (!pharmacy.notes || !pharmacy.notes.length) {
            notesHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
        } else {
            pharmacy.notes.forEach((note, idx) => {
                notesHtml += `
                    <div class="item-card note" onclick="openEditNote(${idx})">
                        <div class="item-title">${note.text}</div>
                        <div class="item-meta">
                            ${new Date(note.date).toLocaleDateString('ru-RU', {
                                day: 'numeric',
                                month: 'short',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteNote(${idx})">‚úï</button>
                    </div>
                `;
            });
        }
        document.getElementById('pharmacyNotesList').innerHTML = notesHtml;

        let tasksHtml = '';
        const visibleTasks = pharmacy.tasks ? pharmacy.tasks.filter(t => !t.completed || showCompletedTasks.pharmacy) : [];

        if (!visibleTasks.length) {
            tasksHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        } else {
            visibleTasks.forEach((task, idx) => {
                const actualIdx = pharmacy.tasks.indexOf(task);
                const staff = appData.staff.find(s => s.id === task.staffId);
                const deadline = task.deadline ? new Date(task.deadline) : null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isOverdue = deadline && deadline < today && !task.completed;

                let tagsHtml = '';
                if (task.label) tagsHtml += `<span class="tag">${task.label}</span>`;
                if (staff) tagsHtml += `<span class="tag staff">${staff.name}</span>`;
                if (deadline) tagsHtml += `<span class="tag ${isOverdue ? 'overdue' : 'deadline'}">üìÖ ${deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}</span>`;

                tasksHtml += `
                    <div class="item-card task-card ${task.completed ? 'completed' : ''}" onclick="openEditTask(${actualIdx})">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="event.stopPropagation(); toggleTask(${actualIdx})">
                        <div style="flex: 1;">
                            <div class="item-title">${task.title}</div>
                            <div class="item-meta">${tagsHtml}</div>
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteTask(${actualIdx})">‚úï</button>
                    </div>
                `;
            });
        }
        document.getElementById('pharmacyTasksList').innerHTML = tasksHtml;
    }

    function renderCommon() {
        document.getElementById('contentTitle').textContent = 'üìå –û–±—â–∏–µ –∑–∞–¥–∞—á–∏';

        if (!appData.common) appData.common = { notes: [], tasks: [] };

        let notesHtml = '';
        if (!appData.common.notes || !appData.common.notes.length) {
            notesHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
        } else {
            appData.common.notes.forEach((note, idx) => {
                notesHtml += `
                    <div class="item-card note" onclick="openEditNote(${idx})">
                        <div class="item-title">${note.text}</div>
                        <div class="item-meta">
                            ${new Date(note.date).toLocaleDateString('ru-RU', {
                                day: 'numeric',
                                month: 'short',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteNote(${idx})">‚úï</button>
                    </div>
                `;
            });
        }
        document.getElementById('pharmacyNotesList').innerHTML = notesHtml;

        let tasksHtml = '';
        const visibleTasks = appData.common.tasks ? appData.common.tasks.filter(t => !t.completed || showCompletedTasks.pharmacy) : [];

        if (!visibleTasks.length) {
            tasksHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        } else {
            visibleTasks.forEach((task, idx) => {
                const actualIdx = appData.common.tasks.indexOf(task);
                const staff = appData.staff.find(s => s.id === task.staffId);
                const deadline = task.deadline ? new Date(task.deadline) : null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isOverdue = deadline && deadline < today && !task.completed;

                let tagsHtml = '';
                if (task.label) tagsHtml += `<span class="tag">${task.label}</span>`;
                if (staff) tagsHtml += `<span class="tag staff">${staff.name}</span>`;
                if (deadline) tagsHtml += `<span class="tag ${isOverdue ? 'overdue' : 'deadline'}">üìÖ ${deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}</span>`;

                tasksHtml += `
                    <div class="item-card task-card ${task.completed ? 'completed' : ''}" onclick="openEditTask(${actualIdx})">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="event.stopPropagation(); toggleTask(${actualIdx})">
                        <div style="flex: 1;">
                            <div class="item-title">${task.title}</div>
                            <div class="item-meta">${tagsHtml}</div>
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteTask(${actualIdx})">‚úï</button>
                    </div>
                `;
            });
        }
        document.getElementById('pharmacyTasksList').innerHTML = tasksHtml;
    }

    function renderDashboard() {
        let allTasks = [];

        if (appData.common && appData.common.tasks) {
            appData.common.tasks.forEach((t, idx) => {
                allTasks.push({ ...t, pharmacyId: 'common', pharmacyName: '–û–±—â–∏–µ –∑–∞–¥–∞—á–∏', taskIdx: idx });
            });
        }

        appData.pharmacies.forEach(p => {
            if (!p.tasks) return;
            p.tasks.forEach((t, idx) => {
                allTasks.push({ ...t, pharmacyId: p.id, pharmacyName: `‚Ññ${p.number} ‚Äî ${p.address}`, taskIdx: idx });
            });
        });

        const filteredTasks = allTasks.filter(t => matchesFilters(t) && (!t.completed || showCompletedTasks.dashboard));
        let tasksHtml = '';
        if (!filteredTasks.length) {
            tasksHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        } else {
            filteredTasks.forEach(t => {
                const staff = appData.staff.find(s => s.id === t.staffId);
                const deadline = t.deadline ? new Date(t.deadline) : null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isOverdue = deadline && deadline < today && !t.completed;

                let tagsHtml = `<span class="tag pharmacy">${t.pharmacyName}</span>`;
                if (t.label) tagsHtml += `<span class="tag">${t.label}</span>`;
                if (staff) tagsHtml += `<span class="tag staff">${staff.name}</span>`;
                if (deadline) tagsHtml += `<span class="tag ${isOverdue ? 'overdue' : 'deadline'}">üìÖ ${deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}</span>`;

                tasksHtml += `
                    <div class="item-card task-card ${t.completed ? 'completed' : ''}">
                        <input type="checkbox" class="task-checkbox" ${t.completed ? 'checked' : ''} onchange="toggleAllTask('${t.pharmacyId}', ${t.taskIdx})">
                        <div style="flex: 1;">
                            <div class="item-title">${t.title}</div>
                            <div class="item-meta">${tagsHtml}</div>
                        </div>
                    </div>
                `;
            });
        }
        document.getElementById('allTasksList').innerHTML = tasksHtml;

        let allNotes = [];

        if (appData.common && appData.common.notes) {
            appData.common.notes.forEach(n => {
                allNotes.push({ ...n, pharmacyName: '–û–±—â–∏–µ –∑–∞–¥–∞—á–∏', pharmacyId: 'common' });
            });
        }

        appData.pharmacies.forEach(p => {
            if (!p.notes) return;
            p.notes.forEach(n => {
                allNotes.push({ ...n, pharmacyName: `‚Ññ${p.number} ‚Äî ${p.address}`, pharmacyId: p.id });
            });
        });

        let notesHtml = '';
        if (!allNotes.length) {
            notesHtml = '<div class="empty-state">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
        } else {
            allNotes.forEach(n => {
                const match = !currentFilters.pharmacy || String(n.pharmacyId) === String(currentFilters.pharmacy);
                if (match) {
                    notesHtml += `
                        <div class="item-card note">
                            <div class="item-title">${n.text}</div>
                            <div class="item-meta">
                                <span class="tag pharmacy">${n.pharmacyName}</span>
                                ${new Date(n.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
                            </div>
                        </div>
                    `;
                }
            });
        }
        document.getElementById('allNotesList').innerHTML = notesHtml;
    }

    function toggleAllTask(pharmacyId, taskIdx) {
        let target;
        if (pharmacyId === 'common') {
            target = appData.common;
        } else {
            target = appData.pharmacies.find(p => String(p.id) === String(pharmacyId));
        }

        if (target && target.tasks && target.tasks[taskIdx]) {
            target.tasks[taskIdx].completed = !target.tasks[taskIdx].completed;
            renderDashboard();
            saveData();
        }
    }

    function showDashboard() {
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        const firstNavBtn = document.querySelector('.sidebar-section:first-child .nav-button');
        if (firstNavBtn) firstNavBtn.classList.add('active');

        document.getElementById('dashboardView').style.display = '';
        document.getElementById('pharmacyView').style.display = 'none';
        document.getElementById('contentTitle').textContent = 'üìä –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª';
        updateFilterOptions();
        renderDashboard();
    }

    function showPharmacy() {
        document.getElementById('dashboardView').style.display = 'none';
        document.getElementById('pharmacyView').style.display = '';
        renderPharmacy();
    }

    function showCommon() {
        document.getElementById('dashboardView').style.display = 'none';
        document.getElementById('pharmacyView').style.display = '';
        renderCommon();
    }

    // INIT
    window.addEventListener('DOMContentLoaded', initFirebaseSync);
</script>
</body>
</html>
