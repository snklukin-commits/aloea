
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–ø—Ç–µ—á–Ω–∞—è —Å–µ—Ç—å "–ê–ª–æ—ç" | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --primary-light: #D1FAE5;
            --secondary: #8B5CF6;
            --accent: #F59E0B;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --info: #3B82F6;
            
            --bg-primary: #FFFFFF;
            --bg-secondary: #F9FAFB;
            --bg-tertiary: #F3F4F6;
            
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            
            --border-color: #E5E7EB;
            --border-dark: #D1D5DB;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
        }

        /* HEADER */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 50;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-image {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-title p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-settings {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .btn-settings:hover {
            background: var(--bg-tertiary);
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            min-width: 180px;
            z-index: 1000;
        }

        .settings-dropdown.active {
            display: flex;
        }

        .settings-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover,
        .settings-item:active {
            background: var(--bg-secondary);
        }

        /* MAIN LAYOUT */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .nav-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .nav-button {
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .nav-button:hover,
        .nav-button:active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-button.active {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary);
            font-weight: 600;
        }

        .nav-delete {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .nav-button:hover .nav-delete {
            opacity: 1;
        }

        /* CONTENT */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .content-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .content-header-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .filters-toggle {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s;
            margin: 0 24px 8px 24px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            width: fit-content;
        }

        .filters-toggle:hover,
        .filters-toggle:active {
            background: var(--bg-tertiary);
        }

        .filters-box {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            margin: 0 24px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .filters-box.expanded {
            padding: 16px;
            max-height: 500px;
            margin-bottom: 16px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .filters-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-clear {
            padding: 6px 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-clear:hover,
        .btn-clear:active {
            background: #DC2626;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-secondary);
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        /* CARDS */
        .card {
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-title-icon {
            font-size: 18px;
        }

        .card-header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-header-action {
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-header-action:hover,
        .btn-header-action:active {
            background: var(--bg-tertiary);
        }

        .card-body {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            gap: 8px;
            min-height: 0;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .btn-add:hover,
        .btn-add:active {
            background: var(--primary-dark);
        }

        /* ITEMS */
        .item {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .item:hover,
        .item:active {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .item-checkbox {
            width: 16px;
            height: 16px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
            flex-shrink: 0;
        }

        .item-content {
            flex: 1;
            min-width: 0;
        }

        .item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
            word-break: break-word;
        }

        .item.completed .item-title {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 11px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge.staff {
            background: rgba(139, 92, 246, 0.1);
            color: #7C3AED;
        }

        .badge.deadline {
            background: rgba(245, 158, 11, 0.1);
            color: #D97706;
        }

        .badge.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }

        .item-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            flex-shrink: 0;
        }

        .item:hover .item-delete {
            opacity: 1;
            color: var(--danger);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }

        .modal-close:hover,
        .modal-close:active {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-required::after {
            content: " *";
            color: var(--danger);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            flex: 1;
        }

        .btn-primary:hover,
        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            flex: 1;
        }

        .btn-secondary:hover,
        .btn-secondary:active {
            background: var(--bg-tertiary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            margin-left: auto;
        }

        .btn-danger:hover,
        .btn-danger:active {
            background: #DC2626;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .table th {
            background: var(--bg-secondary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .table tr:hover {
            background: var(--bg-secondary);
        }

        .label-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .label-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .label-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* TABLET */
        @media (max-width: 1400px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* LARGE MOBILE */
        @media (max-width: 1024px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* MOBILE */
        @media (max-width: 768px) {
            .app-container {
                height: calc(100vh - 12px);
            }

            .header {
                padding: 12px 16px;
                gap: 8px;
            }

            .header-left {
                gap: 12px;
                min-width: 0;
            }

            .logo-section {
                gap: 8px;
            }

            .logo-image {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .header-title h1 {
                font-size: 16px;
            }

            .header-title p {
                font-size: 11px;
            }

            .btn-settings {
                padding: 6px 10px;
                font-size: 12px;
            }

            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 8px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                gap: 0;
                display: grid;
                grid-template-columns: auto auto;
                padding-bottom: 4px;
            }

            .sidebar-section {
                margin-bottom: 0;
                white-space: nowrap;
                display: flex;
                gap: 4px;
                align-items: center;
                border-right: 1px solid var(--border-color);
                padding-right: 12px;
                padding-left: 4px;
            }

            .sidebar-section:nth-child(2) {
                grid-column: 2 / 3;
                border-right: none;
                border-left: 1px solid var(--border-color);
                padding-left: 12px;
                padding-right: 0;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .sidebar-title {
                display: none;
            }

            .nav-list {
                flex-direction: row;
                gap: 3px;
            }

            .nav-button {
                padding: 6px 10px;
                font-size: 11px;
                height: fit-content;
                white-space: nowrap;
            }

            .nav-delete {
                display: none;
            }

            .content {
                flex: 1;
            }

            .content-header {
                padding: 12px 16px;
                gap: 8px;
            }

            .content-header h2 {
                font-size: 16px;
            }

            .content-header-subtitle {
                font-size: 11px;
            }

            .filters-toggle {
                margin: 12px 16px 0 16px;
                padding: 6px 12px;
                font-size: 12px;
            }

            .filters-box {
                margin: 0 16px;
            }

            .filters-box.expanded {
                padding: 12px;
                margin-bottom: 12px;
            }

            .filters-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .filter-label {
                font-size: 10px;
            }

            .filter-select {
                padding: 6px 8px;
                font-size: 11px;
            }

            .content-area {
                padding: 12px;
                gap: 12px;
            }

            .grid-layout {
                gap: 12px;
            }

            .card {
                border-radius: 10px;
            }

            .card-header {
                padding: 12px;
                gap: 8px;
            }

            .card-title {
                gap: 6px;
                font-size: 13px;
            }

            .card-title-icon {
                font-size: 16px;
            }

            .card-body {
                padding: 12px;
                gap: 6px;
            }

            .btn-add {
                padding: 8px;
                font-size: 12px;
                margin-bottom: 10px;
            }

            .item {
                padding: 10px;
                gap: 8px;
            }

            .item-title {
                font-size: 12px;
                margin-bottom: 4px;
            }

            .item-meta {
                gap: 4px;
                font-size: 10px;
            }

            .badge {
                padding: 2px 6px;
                font-size: 10px;
            }

            .empty-state {
                padding: 24px 12px;
            }

            .empty-state-icon {
                font-size: 28px;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 12px;
            }

            .modal {
                max-width: 95vw;
                border-radius: 10px;
            }

            .modal-header {
                padding: 14px 16px;
            }

            .modal-header h2 {
                font-size: 15px;
            }

            .modal-body {
                padding: 14px 16px;
            }

            .modal-footer {
                padding: 12px 16px;
                gap: 6px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-label {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 8px 10px;
                font-size: 12px;
            }

            .form-textarea {
                min-height: 80px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
                gap: 4px;
            }

            .table {
                font-size: 11px;
            }

            .table th {
                padding: 8px;
                font-size: 10px;
            }

            .table td {
                padding: 8px;
            }

            .label-badge {
                padding: 2px 8px;
                font-size: 11px;
            }

            .label-remove {
                font-size: 12px;
            }
        }

        /* SMALL MOBILE */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }

            .logo-image {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .header-title h1 {
                font-size: 14px;
            }

            .header-title p {
                font-size: 10px;
            }

            .btn-settings {
                padding: 5px 8px;
                font-size: 11px;
            }

            .settings-item {
                padding: 10px 12px;
                font-size: 12px;
            }

            .sidebar {
                gap: 0;
            }

            .sidebar-section {
                padding-right: 8px;
            }

            .sidebar-section:nth-child(2) {
                padding-left: 8px;
            }

            .nav-button {
                padding: 5px 8px;
                font-size: 10px;
            }

            .content-header {
                padding: 10px 12px;
            }

            .content-header h2 {
                font-size: 14px;
            }

            .filters-toggle {
                margin: 10px 12px 0 12px;
                padding: 5px 10px;
                font-size: 11px;
            }

            .filters-box {
                margin: 0 12px;
            }

            .filters-box.expanded {
                padding: 10px;
                margin-bottom: 10px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .filter-label {
                font-size: 9px;
            }

            .filter-select {
                padding: 5px 6px;
                font-size: 10px;
            }

            .content-area {
                padding: 10px;
            }

            .grid-layout {
                gap: 10px;
            }

            .card-header {
                padding: 10px;
            }

            .card-title {
                font-size: 12px;
            }

            .card-body {
                padding: 10px;
            }

            .btn-add {
                padding: 6px;
                font-size: 11px;
                margin-bottom: 8px;
            }

            .item {
                padding: 8px;
            }

            .item-title {
                font-size: 11px;
            }

            .item-meta {
                font-size: 9px;
            }

            .badge {
                padding: 1px 5px;
                font-size: 9px;
            }

            .modal-header {
                padding: 12px 14px;
            }

            .modal-header h2 {
                font-size: 14px;
            }

            .modal-body {
                padding: 12px 14px;
            }

            .modal-footer {
                padding: 10px 14px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 7px 8px;
                font-size: 11px;
            }

            .form-textarea {
                min-height: 70px;
            }

            .btn {
                padding: 7px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div class="logo-section">
                <div class="logo-image">üè•</div>
                <div class="header-title">
                    <h1>–ê–ª–æ—ç</h1>
                    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</p>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div style="position: relative;">
                <button class="btn-settings" id="settingsBtn" onclick="toggleSettings(event)">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <div class="settings-dropdown" id="settingsMenu">
                    <div class="settings-item" onclick="openStaffModal()">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
                    <div class="settings-item" onclick="openLabelsModal()">üè∑Ô∏è –Ø—Ä–ª—ã–∫–∏</div>
                    <div class="settings-item" onclick="openPharmacyManagementModal()">üè¢ –ê–ø—Ç–µ–∫–∏</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <ul class="nav-list">
                    <li>
                        <button class="nav-button" onclick="showDashboard()">–°—Ç–æ–ª</button>
                    </li>
                    <li>
                        <button class="nav-button" onclick="selectPharmacy('common')">–û–±—â–∏–µ</button>
                    </li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">–ê–ø—Ç–µ–∫–∏</h3>
                <ul class="nav-list" id="pharmaciesList"></ul>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content">
            <div class="content-header">
                <h2 id="contentTitle">üìä –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</h2>
                <div class="content-header-subtitle" id="contentSubtitle"></div>
            </div>

            <button class="filters-toggle" onclick="toggleFilters()">‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã</button>

            <div class="filters-box" id="filtersBox">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">–ê–ø—Ç–µ–∫–∞</label>
                        <select class="filter-select" id="filterPharmacy" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">–°–æ—Ç—Ä—É–¥.</label>
                        <select class="filter-select" id="filterStaff" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üè∑Ô∏è –Ø—Ä–ª—ã–∫</label>
                        <select class="filter-select" id="filterLabel" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">–°—Ä–æ–∫</label>
                        <select class="filter-select" id="filterDeadline" onchange="applyFilters()">
                            <option value="">–í—Å–µ</option>
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week">–ù–µ–¥–µ–ª—è</option>
                            <option value="month">–ú–µ—Å—è—Ü</option>
                            <option value="overdue">–ü—Ä–æ—Å—Ä.</option>
                        </select>
                    </div>
                </div>
                <div class="filters-footer">
                    <button class="btn-clear" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>

            <div class="content-area">
                <div id="dashboardView">
                    <div class="grid-layout">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span class="card-title-icon">‚úì</span>
                                    <span>–ó–∞–¥–∞—á–∏</span>
                                </div>
                                <div class="card-header-actions">
                                    <button class="btn-header-action" onclick="toggleShowCompleted('dashboard')">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                                </div>
                            </div>
                            <div class="card-body" id="allTasksList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span class="card-title-icon">üìù</span>
                                    <span>–ó–∞–º–µ—Ç–∫–∏</span>
                                </div>
                            </div>
                            <div class="card-body" id="allNotesList"></div>
                        </div>
                    </div>
                </div>

                <div id="pharmacyView" class="grid-layout" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="card-title-icon">‚úì</span>
                                <span>–ó–∞–¥–∞—á–∏</span>
                            </div>
                            <div class="card-header-actions">
                                <button class="btn-header-action" onclick="toggleShowCompleted('pharmacy')">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                            </div>
                        </div>
                        <button class="btn-add" onclick="openAddTask()">+ –ó–∞–¥–∞—á–∞</button>
                        <div class="card-body" id="pharmacyTasksList"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="card-title-icon">üìù</span>
                                <span>–ó–∞–º–µ—Ç–∫–∏</span>
                            </div>
                        </div>
                        <button class="btn-add" onclick="openAddNote()">+ –ó–∞–º–µ—Ç–∫–∞</button>
                        <div class="card-body" id="pharmacyNotesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="pharmacyManagementModal" onclick="closeModalOnBackdrop(event, 'pharmacyManagementModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∞–º–∏</h2>
            <button class="modal-close" onclick="closeModal('pharmacyManagementModal')">√ó</button>
        </div>
        <div class="modal-body">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 16px;" onclick="openCreatePharmacy()">+ –ù–æ–≤–∞—è –∞–ø—Ç–µ–∫–∞</button>
            <div id="pharmacyManagementList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('pharmacyManagementModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="createPharmacyModal" onclick="closeModalOnBackdrop(event, 'createPharmacyModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–°–æ–∑–¥–∞—Ç—å –∞–ø—Ç–µ–∫—É</h2>
            <button class="modal-close" onclick="closeModal('createPharmacyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏</label>
                <input type="text" id="pharmacyNumberInput" class="form-input" placeholder="1">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="pharmacyAddressInput" class="form-input" placeholder="—É–ª. –ü–æ–∫—Ä–æ–≤—Å–∫–∞—è, –¥. 1">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createPharmacyModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="createPharmacy()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editPharmacyModal" onclick="closeModalOnBackdrop(event, 'editPharmacyModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ø—Ç–µ–∫—É</h2>
            <button class="modal-close" onclick="closeModal('editPharmacyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏</label>
                <input type="text" id="editPharmacyNumberInput" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label form-required">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="editPharmacyAddressInput" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editPharmacyModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="saveEditedPharmacy()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addNoteModal" onclick="closeModalOnBackdrop(event, 'addNoteModal')">
    <div class="modal">
        <div class="modal-header">
            <h2 id="noteModalTitle">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
            <button class="modal-close" onclick="closeModal('addNoteModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–¢–µ–∫—Å—Ç</label>
                <textarea id="noteTextInput" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addNoteModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-danger" id="deleteNoteBtn" style="display: none;" onclick="deleteNoteModal()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addTaskModal" onclick="closeModalOnBackdrop(event, 'addTaskModal')">
    <div class="modal">
        <div class="modal-header">
            <h2 id="taskModalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
            <button class="modal-close" onclick="closeModal('addTaskModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label form-required">–ó–∞–¥–∞—á–∞</label>
                <input type="text" id="taskTitleInput" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ...">
            </div>
            <div class="form-group">
                <label class="form-label">–Ø—Ä–ª—ã–∫</label>
                <select id="taskLabelInput" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤.</label>
                <select id="taskStaffInput" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–°—Ä–æ–∫</label>
                <input type="date" id="taskDeadlineInput" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addTaskModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="saveTask()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-danger" id="deleteTaskBtn" style="display: none;" onclick="deleteTaskModal()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="staffModal" onclick="closeModalOnBackdrop(event, 'staffModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
            <button class="modal-close" onclick="closeModal('staffModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 16px;">
                <h3 style="font-size: 13px; margin-bottom: 12px; font-weight: 600;">–î–æ–±–∞–≤–∏—Ç—å</h3>
                <div class="form-group">
                    <label class="form-label form-required">–§–ò–û</label>
                    <input type="text" id="staffNameInput" class="form-input" placeholder="–ò–º—è">
                </div>
                <div class="form-group">
                    <label class="form-label form-required">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <input type="text" id="staffPositionInput" class="form-input" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="staffPhoneInput" class="form-input" placeholder="+7 (900) 000-00-00">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="staffEmailInput" class="form-input" placeholder="email@example.com">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="addStaff()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                <h3 style="font-size: 13px; margin-bottom: 12px; font-weight: 600;">–°–ø–∏—Å–æ–∫</h3>
                <div id="staffTableContainer"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('staffModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="labelsModal" onclick="closeModalOnBackdrop(event, 'labelsModal')">
    <div class="modal">
        <div class="modal-header">
            <h2>–Ø—Ä–ª—ã–∫–∏</h2>
            <button class="modal-close" onclick="closeModal('labelsModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 16px;">
                <h3 style="font-size: 13px; margin-bottom: 12px; font-weight: 600;">–î–æ–±–∞–≤–∏—Ç—å</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="newLabelInput" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." style="flex: 1;">
                    <button class="btn btn-primary" style="flex: 0 0 auto;" onclick="addLabel()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                <h3 style="font-size: 13px; margin-bottom: 12px; font-weight: 600;">–¢–µ–∫—É—â–∏–µ</h3>
                <div class="label-badges" id="labelsListContainer"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('labelsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCXU_qtA65zudpgUsdNdbndOSpuGRbEJ2c",
        authDomain: "pharmacy-manager-d7802.firebaseapp.com",
        projectId: "pharmacy-manager-d7802",
        storageBucket: "pharmacy-manager-d7802.firebasestorage.app",
        messagingSenderId: "60028648458",
        appId: "1:60028648458:web:45e2a124ea3b7d7c46f3f3",
    };

    try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
    } catch(e) { 
        console.error("Firebase Init Fail", e); 
    }

    const DOC_REF = db.collection("pharmacy_app").doc("pharmacy_tasks");

    let appData = {
        pharmacies: [],
        currentPharmacy: null,
        staff: [
            { id: 'staff_1', name: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', position: '–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞', phone: '+7 (904) 252-31-00', email: 'a.bocharova@aloea.ru' },
            { id: 'staff_2', name: '–ö–æ—à–µ–ª–µ–≤–∞ –ï.–ê.', position: '–î–∏—Ä–µ–∫—Ç–æ—Ä –†–µ–≥–∏–æ–Ω–∞', phone: '+7 (904) 653-29-38', email: 'e.kosheleva@aloea.ru' },
            { id: 'staff_3', name: '–ö–ª—é–∫–∏–Ω –°.–ù.', position: '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', phone: '+7 (904) 041-00-17', email: 's.klyukin@aloea.ru' },
            { id: 'staff_4', name: '–í–æ—Å—Ç–æ–∫–æ–≤–∞ –Æ.–í.', position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É', phone: '+7 (919) 025-15-98', email: 'y.vostokova@aloea.ru' },
            { id: 'staff_5', name: '–ü–∞–≤–ª–æ–≤ –ê.–§.', position: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', phone: '+7 (920) 916-97-09', email: 'a.pavlov@aloea.ru' },
        ],
        labels: ['–°—Ä–æ—á–Ω–æ', '–í–∞–∂–Ω–æ', '–†–µ–≥—É–ª—è—Ä–Ω–æ', '–†–µ–∫–ª–∞–º–∞', '–ê–•–û'],
        common: { notes: [], tasks: [] }
    };

    const labelColors = {
        '–°—Ä–æ—á–Ω–æ': { bg: 'linear-gradient(135deg, #EF9A9A 0%, #EF9A9A 100%)', color: '#C62828' },
        '–í–∞–∂–Ω–æ': { bg: 'linear-gradient(135deg, #B39DDB 0%, #B39DDB 100%)', color: '#3F51B5' },
        '–†–µ–≥—É–ª—è—Ä–Ω–æ': { bg: 'linear-gradient(135deg, #FFE0B2 0%, #FFE0B2 100%)', color: '#F57F17' },
        '–†–µ–∫–ª–∞–º–∞': { bg: 'linear-gradient(135deg, #A5D6E8 0%, #A5D6E8 100%)', color: '#7CBCC4' },
        '–ê–•–û': { bg: 'linear-gradient(135deg, #F8BBD0 0%, #F8BBD0 100%)', color: '#C2185B' }
    };

    function getColorForLabel(labelName) {
        return labelColors[labelName] || { bg: 'var(--primary-light)', color: 'var(--primary-dark)' };
    }

    let currentFilters = { pharmacy: '', staff: '', label: '', deadline: '' };
    let showCompletedTasks = { dashboard: false, pharmacy: false };
    let editingPharmacyId = null;
    let editingTask = null, editingNote = null;

    function toggleSettings(e) {
        e.stopPropagation();
        document.getElementById('settingsMenu').classList.toggle('active');
    }

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('settingsMenu');
        const btn = document.getElementById('settingsBtn');
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.classList.remove('active');
        }
    });

    function toggleFilters() {
        document.getElementById('filtersBox').classList.toggle('expanded');
    }

    function toggleShowCompleted(view) {
        showCompletedTasks[view] = !showCompletedTasks[view];
        if (view === 'dashboard') {
            renderDashboard();
        } else {
            if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else {
                renderPharmacy();
            }
        }
    }

    function initFirebaseSync() {
        DOC_REF.onSnapshot((doc) => {
            if (doc.exists) {
                const loaded = doc.data();
                appData.pharmacies = loaded.pharmacies || [];
                appData.currentPharmacy = loaded.currentPharmacy || null;
                appData.labels = loaded.labels || [];
                appData.staff = loaded.staff || [];
                appData.common = loaded.common || { notes: [], tasks: [] };
            }
            
            renderPharmacies();
            updateTaskSelects();
            updateFilterOptions();
            
            if (document.getElementById('dashboardView').style.display !== 'none') {
                renderDashboard();
            } else if (appData.currentPharmacy === 'common') {
                renderCommon();
            } else if (appData.currentPharmacy) {
                renderPharmacy();
            }
        }, (error) => {
            console.error('Firestore listener error:', error);
        });
    }

    function saveData() {
        const dataToSave = {
            pharmacies: appData.pharmacies,
            currentPharmacy: appData.currentPharmacy,
            labels: appData.labels,
            staff: appData.staff,
            common: appData.common
        };

        DOC_REF.set(dataToSave, { merge: true }).catch(err => {
            console.error('Firestore save error:', err);
        });
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function closeModalOnBackdrop(event, modalId) {
        if (event.target.id === modalId) {
            closeModal(modalId);
        }
    }

    // PHARMACIES
    function openPharmacyManagementModal() {
        renderPharmacyManagementList();
        openModal('pharmacyManagementModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function renderPharmacyManagementList() {
        const container = document.getElementById('pharmacyManagementList');
        if (!appData.pharmacies.length) {
            container.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –∞–ø—Ç–µ–∫</p></div>';
            return;
        }

        let html = '<table class="table"><thead><tr><th>‚Ññ</th><th>–ê–¥—Ä–µ—Å</th><th></th></tr></thead><tbody>';
        appData.pharmacies.forEach((p, idx) => {
            const hue = (idx * 50) % 360;
            const bgColor = `hsl(${hue}, 70%, 92%)`;
            html += `<tr style="background-color: ${bgColor};">
                <td><strong>‚Ññ${p.number}</strong></td>
                <td>${p.address}</td>
                <td style="text-align: right;">
                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px; margin-right: 4px;" onclick="openEditPharmacy(${p.id})">‚úé</button>
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 10px;" onclick="deletePharmacy(${p.id})">‚úï</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function openCreatePharmacy() {
        document.getElementById('pharmacyNumberInput').value = '';
        document.getElementById('pharmacyAddressInput').value = '';
        openModal('createPharmacyModal');
    }

    function createPharmacy() {
        const number = document.getElementById('pharmacyNumberInput').value.trim();
        const address = document.getElementById('pharmacyAddressInput').value.trim();

        if (!number || !address) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –∞–¥—Ä–µ—Å –∞–ø—Ç–µ–∫–∏');
            return;
        }

        appData.pharmacies.push({
            id: Date.now(),
            number,
            address,
            notes: [],
            tasks: []
        });

        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        saveData();
        closeModal('createPharmacyModal');
    }

    function openEditPharmacy(id) {
        const pharmacy = appData.pharmacies.find(p => p.id === id);
        if (!pharmacy) return;

        editingPharmacyId = id;
        document.getElementById('editPharmacyNumberInput').value = pharmacy.number || '';
        document.getElementById('editPharmacyAddressInput').value = pharmacy.address || '';
        openModal('editPharmacyModal');
    }

    function saveEditedPharmacy() {
        const pharmacy = appData.pharmacies.find(p => p.id === editingPharmacyId);
        if (!pharmacy) return;

        pharmacy.number = document.getElementById('editPharmacyNumberInput').value.trim();
        pharmacy.address = document.getElementById('editPharmacyAddressInput').value.trim();

        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        if (appData.currentPharmacy === pharmacy.id) {
            showPharmacy();
        }
        saveData();
        closeModal('editPharmacyModal');
    }

    function deletePharmacy(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–ø—Ç–µ–∫—É?')) return;
        appData.pharmacies = appData.pharmacies.filter(p => p.id !== id);
        if (appData.currentPharmacy === id) appData.currentPharmacy = null;
        renderPharmacies();
        renderPharmacyManagementList();
        updateFilterOptions();
        showDashboard();
        saveData();
    }

    function selectPharmacy(id) {
        appData.currentPharmacy = id;
        saveData();
        if (id === 'common') {
            showCommon();
        } else {
            showPharmacy();
        }
    }

    function renderPharmacies() {
        const list = document.getElementById('pharmaciesList');
        list.innerHTML = '';

        appData.pharmacies.forEach((p, idx) => {
            const isActive = appData.currentPharmacy === p.id;
            const hue = (idx * 50) % 360;
            const baseColor = `hsl(${hue}, 70%, 92%)`;
            const borderColor = `hsl(${hue}, 70%, 75%)`;
            const textColor = `hsl(${hue}, 45%, 30%)`;

            const li = document.createElement('li');
            li.innerHTML = `
                <button 
                    class="nav-button ${isActive ? 'active' : ''}" 
                    onclick="selectPharmacy(${p.id})" 
                    title="${p.address}"
                    style="
                        ${isActive ? `
                            background: ${baseColor};
                            border-color: ${borderColor};
                            color: ${textColor};
                            font-weight: 600;
                        ` : ''}
                    "
                >
                    <span>‚Ññ${p.number}</span>
                    <button class="nav-delete" onclick="deletePharmacy(${p.id}); event.stopPropagation();" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                </button>
            `;

            if (!isActive) {
                li.querySelector('.nav-button').addEventListener('mouseenter', function() {
                    this.style.background = baseColor;
                    this.style.borderColor = borderColor;
                    this.style.color = textColor;
                });
                li.querySelector('.nav-button').addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                    this.style.borderColor = 'transparent';
                    this.style.color = 'var(--text-secondary)';
                });
            }

            list.appendChild(li);
        });
    }

    // NOTES
    function openAddNote() {
        if (!appData.currentPharmacy) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É –∏–ª–∏ –û–±—â–∏–µ –∑–∞–¥–∞—á–∏');
            return;
        }
        editingNote = null;
        document.getElementById('noteModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞';
        document.getElementById('deleteNoteBtn').style.display = 'none';
        document.getElementById('noteTextInput').value = '';
        openModal('addNoteModal');
    }

    function openEditNote(noteIdx) {
        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (!target || !target.notes || !target.notes[noteIdx]) return;

        editingNote = { index: noteIdx, pharmacyId: appData.currentPharmacy };
        document.getElementById('noteModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É';
        document.getElementById('deleteNoteBtn').style.display = 'block';
        document.getElementById('noteTextInput').value = target.notes[noteIdx].text;
        openModal('addNoteModal');
    }

    function saveNote() {
        const text = document.getElementById('noteTextInput').value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
            return;
        }

        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (!target) return;

        target.notes = target.notes || [];
        
        if (editingNote) {
            target.notes[editingNote.index].text = text;
        } else {
            target.notes.unshift({ text, date: new Date().toISOString() });
        }

        if (appData.currentPharmacy === 'common') {
            renderCommon();
        } else {
            renderPharmacy();
        }
        renderDashboard();
        saveData();
        closeModal('addNoteModal');
        editingNote = null;
    }

    function deleteNoteModal() {
        if (!editingNote) return;
        let target = editingNote.pharmacyId === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === editingNote.pharmacyId);

        if (target && target.notes) {
            target.notes.splice(editingNote.index, 1);
            if (editingNote.pharmacyId === 'common') renderCommon();
            else renderPharmacy();
            renderDashboard();
            saveData();
            closeModal('addNoteModal');
            editingNote = null;
        }
    }

    function deleteNote(noteIdx) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) return;
        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (target && target.notes) {
            target.notes.splice(noteIdx, 1);
            if (appData.currentPharmacy === 'common') renderCommon();
            else renderPharmacy();
            renderDashboard();
            saveData();
        }
    }

    // TASKS
    function openAddTask() {
        if (!appData.currentPharmacy) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É –∏–ª–∏ –û–±—â–∏–µ –∑–∞–¥–∞—á–∏');
            return;
        }
        editingTask = null;
        document.getElementById('taskModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
        document.getElementById('deleteTaskBtn').style.display = 'none';
        document.getElementById('taskTitleInput').value = '';
        document.getElementById('taskLabelInput').value = '';
        document.getElementById('taskStaffInput').value = '';
        document.getElementById('taskDeadlineInput').value = '';
        updateTaskSelects();
        openModal('addTaskModal');
    }

    function openEditTask(taskIdx) {
        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (!target || !target.tasks || !target.tasks[taskIdx]) return;

        const task = target.tasks[taskIdx];
        editingTask = { index: taskIdx, pharmacyId: appData.currentPharmacy };
        document.getElementById('taskModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
        document.getElementById('deleteTaskBtn').style.display = 'block';
        document.getElementById('taskTitleInput').value = task.title;
        document.getElementById('taskLabelInput').value = task.label || '';
        document.getElementById('taskStaffInput').value = task.staffId || '';
        document.getElementById('taskDeadlineInput').value = task.deadline || '';
        updateTaskSelects();
        openModal('addTaskModal');
    }

    function saveTask() {
        const title = document.getElementById('taskTitleInput').value.trim();
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            return;
        }

        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (!target) return;

        target.tasks = target.tasks || [];
        
        const taskData = {
            title,
            label: document.getElementById('taskLabelInput').value,
            staffId: document.getElementById('taskStaffInput').value,
            deadline: document.getElementById('taskDeadlineInput').value,
            completed: editingTask ? target.tasks[editingTask.index].completed : false
        };

        if (editingTask) {
            target.tasks[editingTask.index] = taskData;
        } else {
            taskData.completed = false;
            target.tasks.unshift(taskData);
        }

        if (appData.currentPharmacy === 'common') renderCommon();
        else renderPharmacy();
        renderDashboard();
        saveData();
        closeModal('addTaskModal');
        editingTask = null;
    }

    function deleteTaskModal() {
        if (!editingTask) return;
        let target = editingTask.pharmacyId === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === editingTask.pharmacyId);

        if (target && target.tasks) {
            target.tasks.splice(editingTask.index, 1);
            if (editingTask.pharmacyId === 'common') renderCommon();
            else renderPharmacy();
            renderDashboard();
            saveData();
            closeModal('addTaskModal');
            editingTask = null;
        }
    }

    function toggleTask(taskIdx) {
        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (target && target.tasks && target.tasks[taskIdx]) {
            target.tasks[taskIdx].completed = !target.tasks[taskIdx].completed;
            if (appData.currentPharmacy === 'common') renderCommon();
            else renderPharmacy();
            renderDashboard();
            saveData();
        }
    }

    function deleteTask(taskIdx) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;

        let target = appData.currentPharmacy === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => p.id === appData.currentPharmacy);

        if (target && target.tasks) {
            target.tasks.splice(taskIdx, 1);
            if (appData.currentPharmacy === 'common') renderCommon();
            else renderPharmacy();
            renderDashboard();
            saveData();
        }
    }

    // STAFF
    function openStaffModal() {
        renderStaffTable();
        openModal('staffModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function addStaff() {
        const name = document.getElementById('staffNameInput').value.trim();
        const position = document.getElementById('staffPositionInput').value.trim();
        if (!name || !position) {
            alert('–§–ò–û –∏ –î–æ–ª–∂–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
            return;
        }
        appData.staff.push({
            id: 'staff_' + Date.now(),
            name,
            position,
            phone: document.getElementById('staffPhoneInput').value.trim(),
            email: document.getElementById('staffEmailInput').value.trim()
        });
        renderStaffTable();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
        document.getElementById('staffNameInput').value = '';
        document.getElementById('staffPositionInput').value = '';
        document.getElementById('staffPhoneInput').value = '';
        document.getElementById('staffEmailInput').value = '';
    }

    function deleteStaff(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
        appData.staff = appData.staff.filter(s => s.id !== id);
        renderStaffTable();
        updateTaskSelects();
        updateFilterOptions();
        renderPharmacy();
        renderDashboard();
        saveData();
    }

    function renderStaffTable() {
        const container = document.getElementById('staffTableContainer');
        if (!appData.staff.length) {
            container.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p></div>';
            return;
        }
        let html = '<table class="table"><thead><tr><th>–§–ò–û</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th></th></tr></thead><tbody>';
        appData.staff.forEach(s => {
            html += `<tr>
                <td>${s.name}</td>
                <td>${s.position}</td>
                <td style="text-align: right;">
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 10px;" onclick="deleteStaff('${s.id}')">‚úï</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // LABELS
    function openLabelsModal() {
        renderLabelsList();
        openModal('labelsModal');
        document.getElementById('settingsMenu').classList.remove('active');
    }

    function addLabel() {
        const name = document.getElementById('newLabelInput').value.trim();
        if (!name || appData.labels.includes(name)) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —è—Ä–ª—ã–∫');
            return;
        }
        appData.labels.push(name);
        renderLabelsList();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
        document.getElementById('newLabelInput').value = '';
    }

    function deleteLabel(name) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —è—Ä–ª—ã–∫?')) return;
        appData.labels = appData.labels.filter(l => l !== name);
        renderLabelsList();
        updateTaskSelects();
        updateFilterOptions();
        saveData();
    }

    function renderLabelsList() {
        const container = document.getElementById('labelsListContainer');
        if (!appData.labels.length) {
            container.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç —è—Ä–ª—ã–∫–æ–≤</p></div>';
            return;
        }
        let html = '';
        appData.labels.forEach(l => {
            const color = getColorForLabel(l);
            html += `<div class="label-badge" style="background: ${color.bg}; color: ${color.color};">${l}<button class="label-remove" onclick="deleteLabel('${l}')" style="color: ${color.color};">‚úï</button></div>`;
        });
        container.innerHTML = html;
    }

    function updateTaskSelects() {
        let labelHtml = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
        appData.labels.forEach(l => { labelHtml += `<option value="${l}">${l}</option>`; });
        document.getElementById('taskLabelInput').innerHTML = labelHtml;

        let staffHtml = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
        appData.staff.forEach(s => { staffHtml += `<option value="${s.id}">${s.name}</option>`; });
        document.getElementById('taskStaffInput').innerHTML = staffHtml;
    }

    // FILTERS
    function updateFilterOptions() {
        let pharmacyHtml = '<option value="">–í—Å–µ</option>';
        pharmacyHtml += `<option value="common">–û–±—â–∏–µ</option>`;
        appData.pharmacies.forEach(p => {
            pharmacyHtml += `<option value="${p.id}">‚Ññ${p.number}</option>`;
        });
        document.getElementById('filterPharmacy').innerHTML = pharmacyHtml;

        let staffHtml = '<option value="">–í—Å–µ</option>';
        appData.staff.forEach(s => {
            staffHtml += `<option value="${s.id}">${s.name}</option>`;
        });
        document.getElementById('filterStaff').innerHTML = staffHtml;

        let labelHtml = '<option value="">–í—Å–µ</option>';
        appData.labels.forEach(l => {
            labelHtml += `<option value="${l}">${l}</option>`;
        });
        document.getElementById('filterLabel').innerHTML = labelHtml;
    }

    function applyFilters() {
        currentFilters.pharmacy = document.getElementById('filterPharmacy').value;
        currentFilters.staff = document.getElementById('filterStaff').value;
        currentFilters.label = document.getElementById('filterLabel').value;
        currentFilters.deadline = document.getElementById('filterDeadline').value;
        renderDashboard();
    }

    function clearFilters() {
        currentFilters = { pharmacy: '', staff: '', label: '', deadline: '' };
        document.getElementById('filterPharmacy').value = '';
        document.getElementById('filterStaff').value = '';
        document.getElementById('filterLabel').value = '';
        document.getElementById('filterDeadline').value = '';
        renderDashboard();
    }

    function matchesFilters(task) {
        if (currentFilters.pharmacy && String(task.pharmacyId) !== String(currentFilters.pharmacy)) return false;
        if (currentFilters.staff && task.staffId !== currentFilters.staff) return false;
        if (currentFilters.label && task.label !== currentFilters.label) return false;
        if (currentFilters.deadline) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadline = task.deadline ? new Date(task.deadline) : null;

            if (!deadline) return false;

            switch (currentFilters.deadline) {
                case 'today':
                    return deadline.getTime() === today.getTime();
                case 'week':
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    return deadline >= today && deadline <= weekEnd;
                case 'month':
                    return deadline.getMonth() === today.getMonth() &&
                           deadline.getFullYear() === today.getFullYear();
                case 'overdue':
                    return deadline < today;
            }
        }
        return true;
    }

    // RENDERING
    function renderPharmacy() {
        const pharmacy = appData.pharmacies.find(p => p.id === appData.currentPharmacy);
        if (!pharmacy) return;

        document.getElementById('contentTitle').textContent = `üì¶ ‚Ññ${pharmacy.number}`;
        document.getElementById('contentSubtitle').textContent = pharmacy.address;

        let notesHtml = '';
        if (!pharmacy.notes || !pharmacy.notes.length) {
            notesHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</p></div>';
        } else {
            notesHtml = pharmacy.notes.map((note, idx) => {
                const noteDate = new Date(note.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: '2-digit' });
                return `
                <div class="item" onclick="openEditNote(${idx})">
                    <div class="item-content">
                        <div class="item-title">${note.text}</div>
                        <div class="item-meta">
                            <span style="color: var(--text-tertiary);">üìÖ ${noteDate}</span>
                        </div>
                    </div>
                    <button class="item-delete" onclick="event.stopPropagation(); deleteNote(${idx})">‚úï</button>
                </div>
            `;
            }).join('');
        }
        document.getElementById('pharmacyNotesList').innerHTML = notesHtml;

        let tasksHtml = '';
        const allTasks = pharmacy.tasks || [];
        const visibleTasks = showCompletedTasks.pharmacy ? allTasks : allTasks.filter(t => !t.completed);

        if (!visibleTasks.length) {
            tasksHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–¥–∞—á</p></div>';
        } else {
            tasksHtml = visibleTasks.map((task, visIdx) => {
                const actualIdx = allTasks.indexOf(task);
                const staff = appData.staff.find(s => s.id === task.staffId);
                let badgesHtml = '';
                if (task.label) {
                    const color = getColorForLabel(task.label);
                    badgesHtml += `<span class="badge" style="background: ${color.bg}; color: ${color.color};">${task.label}</span>`;
                }
                if (staff) badgesHtml += `<span class="badge staff">${staff.name}</span>`;
                if (task.deadline) {
                    const deadline = new Date(task.deadline);
                    const dateStr = deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                    badgesHtml += `<span class="badge">üìÖ ${dateStr}</span>`;
                }

                return `
                    <div class="item ${task.completed ? 'completed' : ''}" onclick="openEditTask(${actualIdx}); event.stopPropagation();">
                        <input type="checkbox" class="item-checkbox" ${task.completed ? 'checked' : ''} onchange="event.stopPropagation(); toggleTask(${actualIdx})">
                        <div class="item-content">
                            <div class="item-title">${task.title}</div>
                            <div class="item-meta">${badgesHtml}</div>
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteTask(${actualIdx})">‚úï</button>
                    </div>
                `;
            }).join('');
        }
        document.getElementById('pharmacyTasksList').innerHTML = tasksHtml;
    }

    function renderCommon() {
        document.getElementById('contentTitle').textContent = 'üìå –û–±—â–∏–µ –∑–∞–¥–∞—á–∏';
        document.getElementById('contentSubtitle').textContent = '';

        let notesHtml = '';
        if (!appData.common.notes || !appData.common.notes.length) {
            notesHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</p></div>';
        } else {
            notesHtml = appData.common.notes.map((note, idx) => {
                const noteDate = new Date(note.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: '2-digit' });
                return `
                <div class="item" onclick="openEditNote(${idx})">
                    <div class="item-content">
                        <div class="item-title">${note.text}</div>
                        <div class="item-meta">
                            <span style="color: var(--text-tertiary);">üìÖ ${noteDate}</span>
                        </div>
                    </div>
                    <button class="item-delete" onclick="event.stopPropagation(); deleteNote(${idx})">‚úï</button>
                </div>
            `;
            }).join('');
        }
        document.getElementById('pharmacyNotesList').innerHTML = notesHtml;

        let tasksHtml = '';
        const allTasks = appData.common.tasks || [];
        const visibleTasks = showCompletedTasks.pharmacy ? allTasks : allTasks.filter(t => !t.completed);

        if (!visibleTasks.length) {
            tasksHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–¥–∞—á</p></div>';
        } else {
            tasksHtml = visibleTasks.map((task, visIdx) => {
                const actualIdx = allTasks.indexOf(task);
                const staff = appData.staff.find(s => s.id === task.staffId);
                let badgesHtml = '';
                if (task.label) {
                    const color = getColorForLabel(task.label);
                    badgesHtml += `<span class="badge" style="background: ${color.bg}; color: ${color.color};">${task.label}</span>`;
                }
                if (staff) badgesHtml += `<span class="badge staff">${staff.name}</span>`;
                if (task.deadline) {
                    const deadline = new Date(task.deadline);
                    const dateStr = deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                    badgesHtml += `<span class="badge">üìÖ ${dateStr}</span>`;
                }

                return `
                    <div class="item ${task.completed ? 'completed' : ''}" onclick="openEditTask(${actualIdx}); event.stopPropagation();">
                        <input type="checkbox" class="item-checkbox" ${task.completed ? 'checked' : ''} onchange="event.stopPropagation(); toggleTask(${actualIdx})">
                        <div class="item-content">
                            <div class="item-title">${task.title}</div>
                            <div class="item-meta">${badgesHtml}</div>
                        </div>
                        <button class="item-delete" onclick="event.stopPropagation(); deleteTask(${actualIdx})">‚úï</button>
                    </div>
                `;
            }).join('');
        }
        document.getElementById('pharmacyTasksList').innerHTML = tasksHtml;
    }

    function renderDashboard() {
        let allTasks = [];

        if (appData.common && appData.common.tasks) {
            appData.common.tasks.forEach((t, idx) => {
                allTasks.push({ ...t, pharmacyId: 'common', pharmacyName: '–û–±—â–∏–µ', taskIdx: idx });
            });
        }

        appData.pharmacies.forEach(p => {
            if (p.tasks) {
                p.tasks.forEach((t, idx) => {
                    allTasks.push({ ...t, pharmacyId: p.id, pharmacyName: `‚Ññ${p.number}`, taskIdx: idx });
                });
            }
        });

        const filteredTasks = allTasks.filter(t => matchesFilters(t) && (!t.completed || showCompletedTasks.dashboard));

        let tasksHtml = '';
        if (!filteredTasks.length) {
            tasksHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–¥–∞—á</p></div>';
        } else {
            tasksHtml = filteredTasks.map(t => {
                const staff = appData.staff.find(s => s.id === t.staffId);
                const idx = appData.pharmacies.findIndex(p => p.id === t.pharmacyId);
                const hue = (Math.max(0, idx) * 50) % 360;
                let badgesHtml = `<span class="badge" style="background: hsl(${hue}, 70%, 92%); color: hsl(${hue}, 45%, 30%);">${t.pharmacyName}</span>`;
                if (t.label) {
                    const color = getColorForLabel(t.label);
                    badgesHtml += `<span class="badge" style="background: ${color.bg}; color: ${color.color};">${t.label}</span>`;
                }
                if (staff) badgesHtml += `<span class="badge staff">${staff.name}</span>`;
                if (t.deadline) {
                    const deadline = new Date(t.deadline);
                    const dateStr = deadline.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                    badgesHtml += `<span class="badge">üìÖ ${dateStr}</span>`;
                }

                return `
                    <div class="item ${t.completed ? 'completed' : ''}">
                        <input type="checkbox" class="item-checkbox" ${t.completed ? 'checked' : ''} onchange="toggleAllTask('${t.pharmacyId}', ${t.taskIdx})">
                        <div class="item-content">
                            <div class="item-title">${t.title}</div>
                            <div class="item-meta">${badgesHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        document.getElementById('allTasksList').innerHTML = tasksHtml;

        let allNotes = [];

        if (appData.common && appData.common.notes) {
            allNotes.push(...appData.common.notes.map(n => ({ ...n, pharmacyName: '–û–±—â–∏–µ', pharmacyId: 'common' })));
        }

        appData.pharmacies.forEach(p => {
            if (p.notes) {
                allNotes.push(...p.notes.map(n => ({ ...n, pharmacyName: `‚Ññ${p.number}`, pharmacyId: p.id })));
            }
        });

        let notesHtml = '';
        if (!allNotes.length) {
            notesHtml = '<div class="empty-state"><p>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</p></div>';
        } else {
            notesHtml = allNotes.map(n => {
                const idx = appData.pharmacies.findIndex(p => p.id === n.pharmacyId);
                const hue = (Math.max(0, idx) * 50) % 360;
                const noteDate = new Date(n.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: '2-digit' });
                return `
                <div class="item">
                    <div class="item-content">
                        <div class="item-title">${n.text}</div>
                        <div class="item-meta">
                            <span class="badge" style="background: hsl(${hue}, 70%, 92%); color: hsl(${hue}, 45%, 30%);">${n.pharmacyName}</span>
                            <span style="color: var(--text-tertiary);">üìÖ ${noteDate}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        document.getElementById('allNotesList').innerHTML = notesHtml;
    }

    function toggleAllTask(pharmacyId, taskIdx) {
        let target = pharmacyId === 'common' 
            ? appData.common 
            : appData.pharmacies.find(p => String(p.id) === String(pharmacyId));

        if (target && target.tasks && target.tasks[taskIdx]) {
            target.tasks[taskIdx].completed = !target.tasks[taskIdx].completed;
            renderDashboard();
            saveData();
        }
    }

    function showDashboard() {
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.sidebar-section:first-child .nav-button:first-child').classList.add('active');
        document.getElementById('dashboardView').style.display = '';
        document.getElementById('pharmacyView').style.display = 'none';
        renderDashboard();
    }

    function showPharmacy() {
        document.getElementById('dashboardView').style.display = 'none';
        document.getElementById('pharmacyView').style.display = '';
        renderPharmacy();
    }

    function showCommon() {
        document.getElementById('dashboardView').style.display = 'none';
        document.getElementById('pharmacyView').style.display = '';
        renderCommon();
    }

    window.addEventListener('DOMContentLoaded', initFirebaseSync);
</script>
</body>
</html>
